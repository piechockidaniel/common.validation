@namespace Atlas.Common.Validation.Blazor
@using System.Linq.Expressions

@if (_messages.Count > 0)
{
    <div class="cv-validation-message @GetSeverityCssClass()">
        @foreach (var message in _messages)
        {
            <span class="cv-message-text">@message.ErrorMessage</span>
        }
    </div>
}

@code {
    private IReadOnlyList<ValidationFailure> _messages = [];

    /// <summary>
    /// The validation result to check for messages.
    /// </summary>
    [Parameter]
    public ValidationResult? Result { get; set; }

    /// <summary>
    /// The property expression to filter messages for (e.g. <c>() => Model.FirstName</c>).
    /// </summary>
    [Parameter]
    public Expression<Func<object>>? For { get; set; }

    /// <summary>
    /// Alternative: the property name to filter messages for (e.g. "FirstName").
    /// </summary>
    [Parameter]
    public string? PropertyName { get; set; }

    protected override void OnParametersSet()
    {
        if (Result is null || Result.IsValid)
        {
            _messages = [];
            return;
        }

        var name = PropertyName ?? ResolvePropertyName();
        if (name is null)
        {
            _messages = [];
            return;
        }

        _messages = Result.Errors
            .Where(predicate: e => string.Equals(a: e.PropertyName, b: name, comparisonType: StringComparison.OrdinalIgnoreCase))
            .ToList()
            .AsReadOnly();
    }

    private string? ResolvePropertyName()
    {
        if (For is null) return null;

        var body = For.Body;

        // Unwrap Convert (boxing)
        if (body is UnaryExpression { NodeType: ExpressionType.Convert } unary)
            body = unary.Operand;

        if (body is MemberExpression member)
            return member.Member.Name;

        return null;
    }

    private string GetSeverityCssClass()
    {
        if (_messages.Count == 0) return string.Empty;

        // Use the highest severity among messages
        var maxSeverity = _messages.Max(selector: m => m.Severity);
        return maxSeverity switch
        {
            Severity.Forbidden => "cv-forbidden",
            Severity.AtOwnRisk => "cv-at-own-risk",
            Severity.NotRecommended => "cv-not-recommended",
            _ => string.Empty
        };
    }
}
